---
# tasks file for ansible-nexus
- name: Download Nexus to control host
  local_action: get_url url=http://download.sonatype.com/nexus/oss/{{ nexus_package }} dest="{{ nexus_download_dir }}/{{ nexus_package }} "
  tags: download
  sudo: no

- name: Ensure Nexus o/s group exists
  group: name="{{ nexus_os_group }}" state=present
  when: nexus_manage_os_group
  sudo: true

- name: Ensure Nexus o/s user exists
  user: name="{{ nexus_os_user }}" group="{{ nexus_os_group }}" shell="{{ nexus_os_user_shell }}" state=present
  when: nexus_manage_os_user
  sudo: true

- name: Ensure Nexus installation directory exists
  file:
    path="{{ nexus_installation_dir }}"
    state="directory"
  sudo: true

- name: Unpack Nexus download
  unarchive:
    src="{{ nexus_download_dir }}/{{ nexus_package }}"
    dest="{{ nexus_installation_dir }}"
    creates="{{ nexus_installation_dir }}/nexus-{{ nexus_version }}"
    force=no
    owner={{ nexus_os_user }}
    group={{ nexus_os_group }}
    mode="0755"
  tags: unpack
  sudo: true

- name: Check if sonatype working directory exists
  stat: path="{{ nexus_installation_dir }}/sonatype-work"
  register: s_w

- name: Move existing sonatype working directory into specified working dir
  command: mv "{{ nexus_installation_dir }}/sonatype-work" "{{ nexus_properties['nexus-work'] }}"
  when: s_w.stat.exists
  sudo: true

- name: Set permissions and ownership on Nexus installation directory
  file:
    path={{ nexus_installation_dir }}/nexus-{{ nexus_version }}
    state="directory"
    owner="{{ nexus_os_user }}"
    group="{{ nexus_os_group }}"
    mode="0755"
    recurse=true
  sudo: true

- name: Set permissions and ownership on Nexus work directory
  file:
    path={{ nexus_properties['nexus-work'] }}
    state="directory"
    owner="{{ nexus_os_user }}"
    group="{{ nexus_os_group }}"
    mode="0755"
    recurse=true
  sudo: true

- name: Configure nexus.properties
  lineinfile:
    dest="{{ nexus_installation_dir }}/nexus-{{ nexus_version }}/conf/nexus.properties"
    line="{{ item.key }}={{ item.value }}"
    regexp="{{ item.key }}=.*"
    state=present
  with_dict: nexus_properties
  sudo: true